#!/bin/bash
# Database backup to Google Drive

DRIVE_PATH="$HOME/Library/CloudStorage/GoogleDrive-zg@kromaprojekts.com/My Drive"
BACKUP_DIR="$DRIVE_PATH/Dojo Backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/dojo_backup_$TIMESTAMP.sql"

mkdir -p "$BACKUP_DIR"

echo "ğŸ”„ Backing up to Google Drive..."

docker exec dojo_allocator-postgres-1 pg_dump -U dojo dojo_allocator > "$BACKUP_FILE"

if [ $? -eq 0 ]; then
    gzip "$BACKUP_FILE"
    COMPRESSED="${BACKUP_FILE}.gz"
    SIZE=$(du -h "$COMPRESSED" | cut -f1)
    FILENAME=$(basename "$COMPRESSED")
    
    echo "âœ… Backup complete!"
    echo "ğŸ“ Location: Dojo Backups/$FILENAME"
    echo "ğŸ“Š Size: $SIZE"
    echo "â˜ï¸  Syncing to Google Drive cloud..."
    
    # Keep last 30 backups
    ls -t "$BACKUP_DIR"/dojo_backup_*.sql.gz 2>/dev/null | tail -n +31 | xargs rm -f 2>/dev/null
    
    COUNT=$(ls "$BACKUP_DIR"/dojo_backup_*.sql.gz 2>/dev/null | wc -l | tr -d ' ')
    echo "ğŸ“¦ Total backups in Drive: $COUNT"
    
    # Open Finder to show backup
    open "$BACKUP_DIR"
else
    echo "âŒ Backup failed"
    exit 1
fi
